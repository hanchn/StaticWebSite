<!-- Posts Header -->
<div class="admin-header">
    <div class="header-left">
        <h1 class="admin-title">
            <i class="fas fa-file-alt"></i>
            文章管理
        </h1>
        <p class="admin-subtitle">管理您的所有博客文章</p>
    </div>
    <div class="header-right">
        <a href="/admin/posts/new" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            写新文章
        </a>
    </div>
</div>

<!-- Filter and Search Bar -->
<div class="posts-toolbar">
    <div class="toolbar-left">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="搜索文章标题、内容..." value="<%= query.search || '' %>">
        </div>
        
        <div class="filter-group">
            <select id="statusFilter" class="filter-select">
                <option value="">所有状态</option>
                <option value="published" <%= query.status === 'published' ? 'selected' : '' %>>已发布</option>
                <option value="draft" <%= query.status === 'draft' ? 'selected' : '' %>>草稿</option>
                <option value="private" <%= query.status === 'private' ? 'selected' : '' %>>私有</option>
            </select>
            
            <select id="categoryFilter" class="filter-select">
                <option value="">所有分类</option>
                <% categories.forEach(category => { %>
                <option value="<%= category %>" <%= query.category === category ? 'selected' : '' %>><%= category %></option>
                <% }) %>
            </select>
            
            <select id="sortFilter" class="filter-select">
                <option value="created_desc" <%= query.sort === 'created_desc' ? 'selected' : '' %>>创建时间 ↓</option>
                <option value="created_asc" <%= query.sort === 'created_asc' ? 'selected' : '' %>>创建时间 ↑</option>
                <option value="updated_desc" <%= query.sort === 'updated_desc' ? 'selected' : '' %>>更新时间 ↓</option>
                <option value="updated_asc" <%= query.sort === 'updated_asc' ? 'selected' : '' %>>更新时间 ↑</option>
                <option value="title_asc" <%= query.sort === 'title_asc' ? 'selected' : '' %>>标题 A-Z</option>
                <option value="title_desc" <%= query.sort === 'title_desc' ? 'selected' : '' %>>标题 Z-A</option>
            </select>
        </div>
    </div>
    
    <div class="toolbar-right">
        <div class="view-toggle">
            <button class="view-btn <%= query.view === 'grid' ? 'active' : '' %>" data-view="grid" title="网格视图">
                <i class="fas fa-th"></i>
            </button>
            <button class="view-btn <%= query.view !== 'grid' ? 'active' : '' %>" data-view="list" title="列表视图">
                <i class="fas fa-list"></i>
            </button>
        </div>
        
        <div class="bulk-actions">
            <select id="bulkAction" class="bulk-select" disabled>
                <option value="">批量操作</option>
                <option value="publish">发布</option>
                <option value="draft">设为草稿</option>
                <option value="delete">删除</option>
            </select>
            <button id="applyBulk" class="btn btn-outline" disabled>
                <i class="fas fa-check"></i>
                应用
            </button>
        </div>
    </div>
</div>

<!-- Posts Stats -->
<div class="posts-stats">
    <div class="stat-item">
        <span class="stat-label">总计:</span>
        <span class="stat-value"><%= pagination.total %></span>
    </div>
    <div class="stat-item">
        <span class="stat-label">已发布:</span>
        <span class="stat-value"><%= stats.published || 0 %></span>
    </div>
    <div class="stat-item">
        <span class="stat-label">草稿:</span>
        <span class="stat-value"><%= stats.draft || 0 %></span>
    </div>
    <div class="stat-item">
        <span class="stat-label">私有:</span>
        <span class="stat-value"><%= stats.private || 0 %></span>
    </div>
    <% if (query.search || query.status || query.category) { %>
    <div class="stat-item">
        <a href="/admin/posts" class="clear-filters">
            <i class="fas fa-times"></i>
            清除筛选
        </a>
    </div>
    <% } %>
</div>

<!-- Posts Content -->
<div class="posts-content">
    <% if (posts.length === 0) { %>
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-file-alt"></i>
        </div>
        <h3>暂无文章</h3>
        <% if (query.search || query.status || query.category) { %>
        <p>没有找到符合条件的文章，请尝试调整筛选条件。</p>
        <a href="/admin/posts" class="btn btn-outline">清除筛选</a>
        <% } else { %>
        <p>您还没有创建任何文章，现在就开始写作吧！</p>
        <a href="/admin/posts/new" class="btn btn-primary">写第一篇文章</a>
        <% } %>
    </div>
    <% } else { %>
    
    <!-- Posts Grid/List -->
    <div class="posts-container <%= query.view === 'grid' ? 'grid-view' : 'list-view' %>">
        <% if (query.view !== 'grid') { %>
        <!-- List Header -->
        <div class="posts-header">
            <div class="header-checkbox">
                <input type="checkbox" id="selectAll">
            </div>
            <div class="header-title">标题</div>
            <div class="header-category">分类</div>
            <div class="header-status">状态</div>
            <div class="header-date">日期</div>
            <div class="header-actions">操作</div>
        </div>
        <% } %>
        
        <!-- Posts List -->
        <div class="posts-list">
            <% posts.forEach(post => { %>
            <div class="post-item" data-id="<%= post.slug %>">
                <% if (query.view === 'grid') { %>
                <!-- Grid View -->
                <div class="post-card">
                    <div class="post-checkbox">
                        <input type="checkbox" class="post-select" value="<%= post.slug %>">
                    </div>
                    
                    <div class="post-cover">
                        <% if (post.cover) { %>
                        <img src="<%= post.cover %>" alt="<%= post.title %>" loading="lazy">
                        <% } else { %>
                        <div class="post-cover-placeholder">
                            <i class="fas fa-image"></i>
                        </div>
                        <% } %>
                        
                        <div class="post-overlay">
                            <div class="post-actions">
                                <a href="/admin/posts/edit/<%= post.slug %>" class="action-btn" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="/posts/<%= post.slug %>" class="action-btn" title="查看" target="_blank">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="action-btn delete-btn" data-slug="<%= post.slug %>" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="post-info">
                        <div class="post-status <%= post.status %>">
                            <%= getStatusText(post.status) %>
                        </div>
                        
                        <h3 class="post-title">
                            <a href="/admin/posts/edit/<%= post.slug %>"><%= post.title %></a>
                        </h3>
                        
                        <div class="post-excerpt">
                            <%= post.excerpt || post.description || '' %>
                        </div>
                        
                        <div class="post-meta">
                            <div class="meta-item">
                                <i class="fas fa-folder"></i>
                                <span><%= post.category || '未分类' %></span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span><%= formatDate(post.created_at) %></span>
                            </div>
                            <% if (post.tags && post.tags.length > 0) { %>
                            <div class="meta-item">
                                <i class="fas fa-tags"></i>
                                <span><%= post.tags.slice(0, 2).join(', ') %><%= post.tags.length > 2 ? '...' : '' %></span>
                            </div>
                            <% } %>
                        </div>
                        
                        <div class="post-stats">
                            <span class="stat">
                                <i class="fas fa-eye"></i>
                                <%= post.views || 0 %>
                            </span>
                            <span class="stat">
                                <i class="fas fa-clock"></i>
                                <%= post.reading_time || 0 %> 分钟
                            </span>
                            <% if (post.updated_at !== post.created_at) { %>
                            <span class="stat updated" title="最后更新: <%= formatDate(post.updated_at) %>">
                                <i class="fas fa-sync"></i>
                                已更新
                            </span>
                            <% } %>
                        </div>
                    </div>
                </div>
                <% } else { %>
                <!-- List View -->
                <div class="post-row">
                    <div class="row-checkbox">
                        <input type="checkbox" class="post-select" value="<%= post.slug %>">
                    </div>
                    
                    <div class="row-title">
                        <div class="title-content">
                            <h3>
                                <a href="/admin/posts/edit/<%= post.slug %>"><%= post.title %></a>
                            </h3>
                            <div class="title-meta">
                                <% if (post.tags && post.tags.length > 0) { %>
                                <div class="tags">
                                    <% post.tags.slice(0, 3).forEach(tag => { %>
                                    <span class="tag"><%= tag %></span>
                                    <% }) %>
                                    <% if (post.tags.length > 3) { %>
                                    <span class="tag-more">+<%= post.tags.length - 3 %></span>
                                    <% } %>
                                </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row-category">
                        <span class="category-badge"><%= post.category || '未分类' %></span>
                    </div>
                    
                    <div class="row-status">
                        <span class="status-badge <%= post.status %>">
                            <%= getStatusText(post.status) %>
                        </span>
                    </div>
                    
                    <div class="row-date">
                        <div class="date-info">
                            <div class="created-date">
                                <%= formatDate(post.created_at) %>
                            </div>
                            <% if (post.updated_at !== post.created_at) { %>
                            <div class="updated-date">
                                更新: <%= formatDate(post.updated_at) %>
                            </div>
                            <% } %>
                        </div>
                    </div>
                    
                    <div class="row-actions">
                        <div class="action-buttons">
                            <a href="/admin/posts/edit/<%= post.slug %>" class="btn btn-sm btn-outline" title="编辑">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="/posts/<%= post.slug %>" class="btn btn-sm btn-outline" title="查看" target="_blank">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button class="btn btn-sm btn-danger delete-btn" data-slug="<%= post.slug %>" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        <div class="row-stats">
                            <span class="views" title="浏览量">
                                <i class="fas fa-eye"></i>
                                <%= post.views || 0 %>
                            </span>
                        </div>
                    </div>
                </div>
                <% } %>
            </div>
            <% }) %>
        </div>
    </div>
    
    <!-- Pagination -->
    <% if (pagination.totalPages > 1) { %>
    <div class="pagination-container">
        <div class="pagination-info">
            显示第 <%= (pagination.currentPage - 1) * pagination.limit + 1 %> - <%= Math.min(pagination.currentPage * pagination.limit, pagination.total) %> 项，共 <%= pagination.total %> 项
        </div>
        
        <nav class="pagination">
            <% if (pagination.currentPage > 1) { %>
            <a href="?<%= buildQuery({...query, page: 1}) %>" class="page-link first">
                <i class="fas fa-angle-double-left"></i>
            </a>
            <a href="?<%= buildQuery({...query, page: pagination.currentPage - 1}) %>" class="page-link prev">
                <i class="fas fa-angle-left"></i>
            </a>
            <% } %>
            
            <% for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) { %>
            <a href="?<%= buildQuery({...query, page: i}) %>" class="page-link <%= i === pagination.currentPage ? 'active' : '' %>">
                <%= i %>
            </a>
            <% } %>
            
            <% if (pagination.currentPage < pagination.totalPages) { %>
            <a href="?<%= buildQuery({...query, page: pagination.currentPage + 1}) %>" class="page-link next">
                <i class="fas fa-angle-right"></i>
            </a>
            <a href="?<%= buildQuery({...query, page: pagination.totalPages}) %>" class="page-link last">
                <i class="fas fa-angle-double-right"></i>
            </a>
            <% } %>
        </nav>
    </div>
    <% } %>
    
    <% } %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化页面
    initPostsPage();
    
    function initPostsPage() {
        // 绑定事件
        bindSearchEvents();
        bindFilterEvents();
        bindViewToggle();
        bindBulkActions();
        bindDeleteActions();
        
        // 初始化选择状态
        updateBulkActionState();
    }
    
    function bindSearchEvents() {
        const searchInput = document.getElementById('searchInput');
        if (!searchInput) return;
        
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                updateFilters();
            }, 500);
        });
        
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                updateFilters();
            }
        });
    }
    
    function bindFilterEvents() {
        const filters = ['statusFilter', 'categoryFilter', 'sortFilter'];
        
        filters.forEach(filterId => {
            const filter = document.getElementById(filterId);
            if (filter) {
                filter.addEventListener('change', updateFilters);
            }
        });
    }
    
    function bindViewToggle() {
        const viewButtons = document.querySelectorAll('.view-btn');
        
        viewButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const view = this.dataset.view;
                
                // 更新按钮状态
                viewButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // 更新视图
                const container = document.querySelector('.posts-container');
                if (container) {
                    container.className = `posts-container ${view}-view`;
                }
                
                // 更新 URL
                updateFilters({ view });
            });
        });
    }
    
    function bindBulkActions() {
        const selectAll = document.getElementById('selectAll');
        const postSelects = document.querySelectorAll('.post-select');
        const bulkAction = document.getElementById('bulkAction');
        const applyBulk = document.getElementById('applyBulk');
        
        // 全选/取消全选
        if (selectAll) {
            selectAll.addEventListener('change', function() {
                postSelects.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateBulkActionState();
            });
        }
        
        // 单个选择
        postSelects.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectAllState();
                updateBulkActionState();
            });
        });
        
        // 应用批量操作
        if (applyBulk) {
            applyBulk.addEventListener('click', function() {
                const action = bulkAction.value;
                const selected = Array.from(postSelects)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                if (!action || selected.length === 0) return;
                
                applyBulkAction(action, selected);
            });
        }
    }
    
    function bindDeleteActions() {
        const deleteButtons = document.querySelectorAll('.delete-btn');
        
        deleteButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const slug = this.dataset.slug;
                if (slug) {
                    deletePost(slug);
                }
            });
        });
    }
    
    function updateFilters(extraParams = {}) {
        const params = new URLSearchParams();
        
        // 获取当前筛选值
        const search = document.getElementById('searchInput')?.value || '';
        const status = document.getElementById('statusFilter')?.value || '';
        const category = document.getElementById('categoryFilter')?.value || '';
        const sort = document.getElementById('sortFilter')?.value || '';
        const view = extraParams.view || new URLSearchParams(window.location.search).get('view') || 'list';
        
        // 构建参数
        if (search) params.set('search', search);
        if (status) params.set('status', status);
        if (category) params.set('category', category);
        if (sort) params.set('sort', sort);
        if (view !== 'list') params.set('view', view);
        
        // 添加额外参数
        Object.entries(extraParams).forEach(([key, value]) => {
            if (value) params.set(key, value);
        });
        
        // 跳转
        const url = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.location.href = url;
    }
    
    function updateSelectAllState() {
        const selectAll = document.getElementById('selectAll');
        const postSelects = document.querySelectorAll('.post-select');
        
        if (!selectAll || postSelects.length === 0) return;
        
        const checkedCount = Array.from(postSelects).filter(cb => cb.checked).length;
        
        if (checkedCount === 0) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        } else if (checkedCount === postSelects.length) {
            selectAll.checked = true;
            selectAll.indeterminate = false;
        } else {
            selectAll.checked = false;
            selectAll.indeterminate = true;
        }
    }
    
    function updateBulkActionState() {
        const postSelects = document.querySelectorAll('.post-select');
        const bulkAction = document.getElementById('bulkAction');
        const applyBulk = document.getElementById('applyBulk');
        
        const selectedCount = Array.from(postSelects).filter(cb => cb.checked).length;
        const hasSelection = selectedCount > 0;
        
        if (bulkAction) bulkAction.disabled = !hasSelection;
        if (applyBulk) applyBulk.disabled = !hasSelection;
    }
    
    async function applyBulkAction(action, slugs) {
        const actionNames = {
            'publish': '发布',
            'draft': '设为草稿',
            'delete': '删除'
        };
        
        const actionName = actionNames[action] || action;
        
        if (!confirm(`确定要${actionName}选中的 ${slugs.length} 篇文章吗？`)) {
            return;
        }
        
        try {
            showLoading(`正在${actionName}文章...`);
            
            const response = await fetch('/admin/api/posts/bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: action,
                    slugs: slugs
                })
            });
            
            const result = await response.json();
            
            hideLoading();
            
            if (result.success) {
                showToast(`成功${actionName} ${result.count} 篇文章`, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast(`${actionName}失败: ` + result.message, 'error');
            }
        } catch (error) {
            hideLoading();
            showToast(`${actionName}失败`, 'error');
            console.error('批量操作失败:', error);
        }
    }
    
    async function deletePost(slug) {
        if (!confirm('确定要删除这篇文章吗？此操作不可撤销。')) {
            return;
        }
        
        try {
            showLoading('正在删除文章...');
            
            const response = await fetch(`/admin/api/posts/${slug}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            hideLoading();
            
            if (result.success) {
                showToast('文章删除成功', 'success');
                
                // 移除文章项
                const postItem = document.querySelector(`[data-id="${slug}"]`);
                if (postItem) {
                    postItem.style.opacity = '0.5';
                    setTimeout(() => {
                        postItem.remove();
                        updateSelectAllState();
                        updateBulkActionState();
                    }, 300);
                }
            } else {
                showToast('删除失败: ' + result.message, 'error');
            }
        } catch (error) {
            hideLoading();
            showToast('删除失败', 'error');
            console.error('删除文章失败:', error);
        }
    }
});

// 辅助函数
function getStatusText(status) {
    const statusMap = {
        'published': '已发布',
        'draft': '草稿',
        'private': '私有'
    };
    return statusMap[status] || status;
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
}

function buildQuery(params) {
    const query = new URLSearchParams();
    Object.entries(params).forEach(([key, value]) => {
        if (value) query.set(key, value);
    });
    return query.toString();
}
</script>