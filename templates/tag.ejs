<!-- Tag Header -->
<header class="tag-header">
  <div class="tag-info">
    <h1 class="tag-title">
      <span class="tag-icon">#</span>
      <%= tag.name %>
    </h1>
    <% if (tag.description) { %>
    <p class="tag-description"><%= tag.description %></p>
    <% } %>
    
    <div class="tag-meta">
      <span class="tag-count"><%= posts.length %> ç¯‡æ–‡ç« </span>
      <% if (tag.color) { %>
      <span class="tag-color" data-color="<%= tag.color %>"></span>
      <% } %>
    </div>
  </div>
  
  <div class="tag-actions">
    <a href="/posts/" class="btn btn-secondary">æ‰€æœ‰æ–‡ç« </a>
    <a href="/tags/" class="btn btn-outline">æ‰€æœ‰æ ‡ç­¾</a>
  </div>
</header>

<!-- Posts List -->
<% if (posts && posts.length > 0) { %>
<section class="tag-posts">
  <div class="posts-header">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    
    <div class="posts-sort">
      <select id="sort-posts" class="sort-select">
        <option value="date-desc">æœ€æ–°å‘å¸ƒ</option>
        <option value="date-asc">æœ€æ—©å‘å¸ƒ</option>
        <option value="title">æ ‡é¢˜æ’åº</option>
      </select>
    </div>
  </div>
  
  <div class="posts-list" id="posts-list">
    <% posts.forEach(function(post, index) { %>
    <article class="post-item" data-date="<%= new Date(post.date).getTime() %>" data-title="<%= post.title.toLowerCase() %>">
      <div class="post-meta">
        <time class="post-date" datetime="<%= new Date(post.date).toISOString() %>">
          <%= new Date(post.date).toLocaleDateString('zh-CN') %>
        </time>
        <% if (post.category) { %>
        <span class="post-category"><%= post.category %></span>
        <% } %>
      </div>
      
      <h3 class="post-title">
        <a href="<%= post.url %>"><%= post.title %></a>
      </h3>
      
      <% if (post.excerpt) { %>
      <p class="post-excerpt"><%= post.excerpt %></p>
      <% } %>
      
      <div class="post-footer">
        <div class="post-tags">
          <% if (post.tags && post.tags.length > 0) { %>
            <% post.tags.forEach(function(postTag) { %>
              <% if (postTag !== tag.name) { %>
              <a href="/tags/<%= postTag.toLowerCase().replace(/\s+/g, '-') %>/" class="tag">#<%= postTag %></a>
              <% } %>
            <% }); %>
          <% } %>
        </div>
        
        <div class="post-actions">
          <a href="<%= post.url %>" class="read-more">é˜…è¯»æ›´å¤š</a>
          <% if (post.readingTime) { %>
          <span class="reading-time"><%= post.readingTime %> åˆ†é’Ÿ</span>
          <% } %>
        </div>
      </div>
    </article>
    <% }); %>
  </div>
</section>
<% } else { %>
<div class="empty-state">
  <div class="empty-icon">ğŸ·ï¸</div>
  <h3>æš‚æ— ç›¸å…³æ–‡ç« </h3>
  <p>è¯¥æ ‡ç­¾ä¸‹è¿˜æ²¡æœ‰ä»»ä½•æ–‡ç« ã€‚</p>
  <a href="/posts/" class="btn btn-primary">æµè§ˆæ‰€æœ‰æ–‡ç« </a>
</div>
<% } %>

<!-- Related Tags -->
<% if (relatedTags && relatedTags.length > 0) { %>
<section class="related-tags">
  <h2 class="section-title">ç›¸å…³æ ‡ç­¾</h2>
  
  <div class="tags-cloud">
    <% relatedTags.forEach(function(relatedTag) { %>
    <a href="/tags/<%= relatedTag.slug %>/" class="tag-link" data-count="<%= relatedTag.count %>">
      <span class="tag-name">#<%= relatedTag.name %></span>
      <span class="tag-count">(<%= relatedTag.count %>)</span>
    </a>
    <% }); %>
  </div>
</section>
<% } %>

<!-- Tag Statistics -->
<% if (posts && posts.length > 0) { %>
<section class="tag-stats">
  <h2 class="section-title">ç»Ÿè®¡ä¿¡æ¯</h2>
  
  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-number"><%= posts.length %></div>
      <div class="stat-label">æ–‡ç« æ•°é‡</div>
    </div>
    
    <div class="stat-item">
      <div class="stat-number"><%= posts.reduce((total, post) => total + (post.readingTime || 5), 0) %></div>
      <div class="stat-label">æ€»é˜…è¯»æ—¶é—´(åˆ†é’Ÿ)</div>
    </div>
    
    <div class="stat-item">
      <div class="stat-number"><%= new Date(Math.max(...posts.map(p => new Date(p.date)))).getFullYear() %></div>
      <div class="stat-label">æœ€æ–°æ–‡ç« å¹´ä»½</div>
    </div>
    
    <div class="stat-item">
      <div class="stat-number"><%= new Set(posts.map(p => p.category).filter(Boolean)).size %></div>
      <div class="stat-label">æ¶‰åŠåˆ†ç±»</div>
    </div>
  </div>
</section>
<% } %>

<script>
// æ–‡ç« æ’åºåŠŸèƒ½
(function() {
  const sortSelect = document.getElementById('sort-posts');
  const postsList = document.getElementById('posts-list');
  
  if (!sortSelect || !postsList) return;
  
  const posts = Array.from(postsList.querySelectorAll('.post-item'));
  
  function sortPosts() {
    const sortBy = sortSelect.value;
    
    const sortedPosts = posts.sort((a, b) => {
      switch (sortBy) {
        case 'date-desc':
          return parseInt(b.dataset.date) - parseInt(a.dataset.date);
        case 'date-asc':
          return parseInt(a.dataset.date) - parseInt(b.dataset.date);
        case 'title':
          return a.dataset.title.localeCompare(b.dataset.title);
        default:
          return 0;
      }
    });
    
    // é‡æ–°æ’åˆ— DOM å…ƒç´ 
    sortedPosts.forEach(post => {
      postsList.appendChild(post);
    });
  }
  
  sortSelect.addEventListener('change', sortPosts);
})();

// æ ‡ç­¾äº‘æ•ˆæœ
(function() {
  const tagLinks = document.querySelectorAll('.tag-link');
  
  if (tagLinks.length === 0) return;
  
  // æ ¹æ®æ–‡ç« æ•°é‡è°ƒæ•´æ ‡ç­¾å¤§å°
  const counts = Array.from(tagLinks).map(link => parseInt(link.dataset.count));
  const maxCount = Math.max(...counts);
  const minCount = Math.min(...counts);
  
  tagLinks.forEach(link => {
    const count = parseInt(link.dataset.count);
    const ratio = (count - minCount) / (maxCount - minCount) || 0;
    const fontSize = 0.8 + (ratio * 0.6); // 0.8em to 1.4em
    
    link.style.fontSize = fontSize + 'em';
    link.style.opacity = 0.6 + (ratio * 0.4); // 0.6 to 1.0
  });
})();
</script>