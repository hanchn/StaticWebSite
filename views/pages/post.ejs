<!-- Article Header -->
<article class="post-article">
    <header class="post-header">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="/" class="breadcrumb-link">首页</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/posts" class="breadcrumb-link">文章</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/category/<%= post.category %>" class="breadcrumb-link"><%= post.category %></a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current"><%= post.title %></span>
        </nav>
        
        <!-- Post Meta -->
        <div class="post-meta">
            <time class="post-date" datetime="<%= post.date %>">
                <i class="fas fa-calendar"></i>
                <%= moment(post.date).format('YYYY年MM月DD日') %>
            </time>
            
            <span class="post-category">
                <i class="fas fa-folder"></i>
                <a href="/category/<%= post.category %>"><%= post.category %></a>
            </span>
            
            <% if (post.author) { %>
            <span class="post-author">
                <i class="fas fa-user"></i>
                <%= post.author %>
            </span>
            <% } %>
            
            <span class="post-reading-time">
                <i class="fas fa-clock"></i>
                <%= post.readingTime %> 分钟阅读
            </span>
            
            <% if (post.views) { %>
            <span class="post-views">
                <i class="fas fa-eye"></i>
                <%= post.views %> 次阅读
            </span>
            <% } %>
        </div>
        
        <!-- Post Title -->
        <h1 class="post-title"><%= post.title %></h1>
        
        <!-- Post Description -->
        <% if (post.description) { %>
        <p class="post-description"><%= post.description %></p>
        <% } %>
        
        <!-- Post Cover -->
        <% if (post.cover) { %>
        <div class="post-cover">
            <img src="<%= post.cover %>" alt="<%= post.title %>" loading="lazy">
        </div>
        <% } %>
        
        <!-- Post Tags -->
        <% if (post.tags && post.tags.length > 0) { %>
        <div class="post-tags">
            <i class="fas fa-tags"></i>
            <% post.tags.forEach(tag => { %>
            <a href="/tag/<%= tag %>" class="tag">#<%= tag %></a>
            <% }); %>
        </div>
        <% } %>
        
        <!-- Social Share -->
        <div class="post-share">
            <span class="share-label">分享到：</span>
            <div class="share-buttons">
                <a href="#" class="share-btn share-weibo" data-platform="weibo" title="分享到微博">
                    <i class="fab fa-weibo"></i>
                </a>
                <a href="#" class="share-btn share-wechat" data-platform="wechat" title="分享到微信">
                    <i class="fab fa-weixin"></i>
                </a>
                <a href="#" class="share-btn share-qq" data-platform="qq" title="分享到QQ">
                    <i class="fab fa-qq"></i>
                </a>
                <a href="#" class="share-btn share-twitter" data-platform="twitter" title="分享到Twitter">
                    <i class="fab fa-twitter"></i>
                </a>
                <a href="#" class="share-btn share-facebook" data-platform="facebook" title="分享到Facebook">
                    <i class="fab fa-facebook"></i>
                </a>
                <button class="share-btn share-copy" data-platform="copy" title="复制链接">
                    <i class="fas fa-link"></i>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Table of Contents -->
    <% if (post.toc && post.toc.length > 0) { %>
    <aside class="post-toc">
        <div class="toc-header">
            <h3>目录</h3>
            <button class="toc-toggle" title="展开/收起目录">
                <i class="fas fa-chevron-up"></i>
            </button>
        </div>
        <nav class="toc-nav">
            <ol class="toc-list">
                <% post.toc.forEach(item => { %>
                <li class="toc-item toc-level-<%= item.level %>">
                    <a href="#<%= item.anchor %>" class="toc-link"><%= item.text %></a>
                </li>
                <% }); %>
            </ol>
        </nav>
    </aside>
    <% } %>
    
    <!-- Post Content -->
    <div class="post-content">
        <%- post.content %>
    </div>
    
    <!-- Post Footer -->
    <footer class="post-footer">
        <!-- Updated Date -->
        <% if (post.updated && post.updated !== post.date) { %>
        <div class="post-updated">
            <i class="fas fa-edit"></i>
            最后更新：<time datetime="<%= post.updated %>"><%= moment(post.updated).format('YYYY年MM月DD日') %></time>
        </div>
        <% } %>
        
        <!-- Copyright -->
        <div class="post-copyright">
            <div class="copyright-item">
                <strong>本文作者：</strong><%= post.author || config.site.author %>
            </div>
            <div class="copyright-item">
                <strong>本文链接：</strong><a href="<%= config.site.url %>/post/<%= post.slug %>"><%= config.site.url %>/post/<%= post.slug %></a>
            </div>
            <div class="copyright-item">
                <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。
            </div>
        </div>
        
        <!-- Post Navigation -->
        <nav class="post-nav">
            <% if (prevPost) { %>
            <div class="post-nav-item post-nav-prev">
                <a href="/post/<%= prevPost.slug %>" class="post-nav-link">
                    <div class="post-nav-direction">
                        <i class="fas fa-chevron-left"></i>
                        上一篇
                    </div>
                    <div class="post-nav-title"><%= prevPost.title %></div>
                </a>
            </div>
            <% } %>
            
            <% if (nextPost) { %>
            <div class="post-nav-item post-nav-next">
                <a href="/post/<%= nextPost.slug %>" class="post-nav-link">
                    <div class="post-nav-direction">
                        下一篇
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="post-nav-title"><%= nextPost.title %></div>
                </a>
            </div>
            <% } %>
        </nav>
    </footer>
</article>

<!-- Related Posts -->
<% if (relatedPosts && relatedPosts.length > 0) { %>
<section class="related-posts">
    <h2 class="section-title">相关文章</h2>
    <div class="related-posts-grid">
        <% relatedPosts.forEach(relatedPost => { %>
        <article class="related-post">
            <% if (relatedPost.cover) { %>
            <div class="related-post-cover">
                <a href="/post/<%= relatedPost.slug %>">
                    <img src="<%= relatedPost.cover %>" alt="<%= relatedPost.title %>" loading="lazy">
                </a>
            </div>
            <% } %>
            
            <div class="related-post-content">
                <div class="related-post-meta">
                    <time class="related-post-date" datetime="<%= relatedPost.date %>">
                        <%= moment(relatedPost.date).format('MM月DD日') %>
                    </time>
                    <span class="related-post-category">
                        <a href="/category/<%= relatedPost.category %>"><%= relatedPost.category %></a>
                    </span>
                </div>
                
                <h3 class="related-post-title">
                    <a href="/post/<%= relatedPost.slug %>"><%= relatedPost.title %></a>
                </h3>
                
                <p class="related-post-excerpt"><%= relatedPost.excerpt %></p>
            </div>
        </article>
        <% }); %>
    </div>
</section>
<% } %>

<!-- Comments Section -->
<section class="comments-section">
    <h2 class="section-title">评论</h2>
    
    <!-- 这里可以集成评论系统，如 Disqus, Gitalk, Valine 等 -->
    <div class="comments-placeholder">
        <div class="comments-info">
            <i class="fas fa-comments"></i>
            <p>评论功能暂未开启</p>
            <p class="comments-note">如需开启评论功能，请在配置文件中设置评论系统。</p>
        </div>
    </div>
    
    <!-- Gitalk 评论示例 -->
    <!-- 
    <div id="gitalk-container"></div>
    <script>
    if (typeof gitalk !== 'undefined') {
        gitalk.render('gitalk-container');
    }
    </script>
    -->
</section>

<!-- Back to Top -->
<button class="back-to-top" id="backToTop" title="返回顶部">
    <i class="fas fa-chevron-up"></i>
</button>

<!-- Reading Progress -->
<div class="reading-progress">
    <div class="reading-progress-bar" id="readingProgress"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Table of Contents functionality
    const tocToggle = document.querySelector('.toc-toggle');
    const tocNav = document.querySelector('.toc-nav');
    const tocLinks = document.querySelectorAll('.toc-link');
    
    if (tocToggle && tocNav) {
        tocToggle.addEventListener('click', function() {
            tocNav.classList.toggle('collapsed');
            const icon = this.querySelector('i');
            icon.classList.toggle('fa-chevron-up');
            icon.classList.toggle('fa-chevron-down');
        });
    }
    
    // Smooth scroll for TOC links
    tocLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Update active TOC item
                tocLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            }
        });
    });
    
    // Highlight current section in TOC
    function updateTocHighlight() {
        const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
        const scrollTop = window.pageYOffset;
        
        let currentHeading = null;
        headings.forEach(heading => {
            if (heading.offsetTop <= scrollTop + 100) {
                currentHeading = heading;
            }
        });
        
        tocLinks.forEach(link => link.classList.remove('active'));
        if (currentHeading && currentHeading.id) {
            const activeLink = document.querySelector(`.toc-link[href="#${currentHeading.id}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }
    }
    
    // Social sharing functionality
    const shareButtons = document.querySelectorAll('.share-btn');
    shareButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const platform = this.dataset.platform;
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(document.title);
            
            let shareUrl = '';
            
            switch (platform) {
                case 'weibo':
                    shareUrl = `https://service.weibo.com/share/share.php?url=${url}&title=${title}`;
                    break;
                case 'qq':
                    shareUrl = `https://connect.qq.com/widget/shareqq/index.html?url=${url}&title=${title}`;
                    break;
                case 'twitter':
                    shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
                    break;
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
                    break;
                case 'wechat':
                    // 微信分享需要特殊处理，这里显示二维码
                    showWechatQR(window.location.href);
                    return;
                case 'copy':
                    copyToClipboard(window.location.href);
                    return;
            }
            
            if (shareUrl) {
                window.open(shareUrl, '_blank', 'width=600,height=400');
            }
        });
    });
    
    // Copy to clipboard function
    function copyToClipboard(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('链接已复制到剪贴板');
            });
        } else {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showToast('链接已复制到剪贴板');
        }
    }
    
    // Show WeChat QR code
    function showWechatQR(url) {
        // 这里可以集成二维码生成库
        showToast('请使用微信扫一扫分享此页面');
    }
    
    // Toast notification
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
    
    // Back to top functionality
    const backToTop = document.getElementById('backToTop');
    
    function toggleBackToTop() {
        if (window.pageYOffset > 300) {
            backToTop.classList.add('visible');
        } else {
            backToTop.classList.remove('visible');
        }
    }
    
    backToTop.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
    
    // Reading progress
    const readingProgress = document.getElementById('readingProgress');
    
    function updateReadingProgress() {
        const article = document.querySelector('.post-content');
        if (!article) return;
        
        const articleTop = article.offsetTop;
        const articleHeight = article.offsetHeight;
        const windowHeight = window.innerHeight;
        const scrollTop = window.pageYOffset;
        
        const progress = Math.max(0, Math.min(100, 
            ((scrollTop - articleTop + windowHeight) / articleHeight) * 100
        ));
        
        readingProgress.style.width = progress + '%';
    }
    
    // Scroll event listener
    let ticking = false;
    function onScroll() {
        if (!ticking) {
            requestAnimationFrame(() => {
                toggleBackToTop();
                updateReadingProgress();
                updateTocHighlight();
                ticking = false;
            });
            ticking = true;
        }
    }
    
    window.addEventListener('scroll', onScroll);
    
    // Initialize
    toggleBackToTop();
    updateReadingProgress();
    updateTocHighlight();
    
    // Image lazy loading and lightbox
    const images = document.querySelectorAll('.post-content img');
    images.forEach(img => {
        // Add click event for lightbox
        img.addEventListener('click', function() {
            showImageLightbox(this.src, this.alt);
        });
        
        // Add loading class
        img.classList.add('lazy-image');
    });
    
    // Simple lightbox implementation
    function showImageLightbox(src, alt) {
        const lightbox = document.createElement('div');
        lightbox.className = 'lightbox';
        lightbox.innerHTML = `
            <div class="lightbox-content">
                <img src="${src}" alt="${alt}">
                <button class="lightbox-close">&times;</button>
            </div>
        `;
        
        document.body.appendChild(lightbox);
        document.body.style.overflow = 'hidden';
        
        // Close lightbox
        function closeLightbox() {
            document.body.removeChild(lightbox);
            document.body.style.overflow = '';
        }
        
        lightbox.addEventListener('click', function(e) {
            if (e.target === lightbox || e.target.classList.contains('lightbox-close')) {
                closeLightbox();
            }
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeLightbox();
            }
        });
    }
    
    // Code block enhancements
    const codeBlocks = document.querySelectorAll('pre code');
    codeBlocks.forEach(block => {
        // Add copy button
        const copyBtn = document.createElement('button');
        copyBtn.className = 'code-copy-btn';
        copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
        copyBtn.title = '复制代码';
        
        copyBtn.addEventListener('click', function() {
            copyToClipboard(block.textContent);
            this.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-copy"></i>';
            }, 2000);
        });
        
        block.parentNode.style.position = 'relative';
        block.parentNode.appendChild(copyBtn);
    });
});
</script>